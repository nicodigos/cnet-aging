<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Accounts Receivable Report</title>

    <style>
        :root {
            /* Lighter, print-friendly heat colors */
            --heat-blue-r: 70;
            --heat-blue-g: 130;
            --heat-blue-b: 220;

            --heat-green-r: 70;
            --heat-green-g: 170;
            --heat-green-b: 110;

            /* Max opacity for heat cells (keep it light) */
            --heat-alpha-max: 0.38;

            /* Past due chips */
            --chip-red-bg: rgba(220, 60, 60, 0.16);
            --chip-red-tx: #7a1c1c;

            --chip-green-bg: rgba(60, 170, 110, 0.16);
            --chip-green-tx: #124d34;

            --ink: #1f2937;
            --muted: #6b7280;
            --line: #d1d5db;
            --panel: #f3f4f6;
        }

        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            font-size: 11px;
            color: var(--ink);
            margin: 18px;
            font-weight: 400;
        }

        .report-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 2px solid var(--line);
            padding-bottom: 10px;
            margin-bottom: 18px;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 0.3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .report-meta {
            text-align: right;
            color: var(--muted);
            font-size: 10px;
            line-height: 1.35;
            white-space: nowrap;
            font-weight: 400;
        }

        .vendor-section {
            margin-top: 18px;
            padding-top: 14px;
            border-top: 1px solid var(--line);
        }

        .vendor-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 0 0 8px 0;
        }

        h2 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .vendor-pill {
            font-size: 10px;
            color: var(--muted);
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 4px 10px;
            white-space: nowrap;
            font-weight: 400;
        }

        h3 {
            margin: 12px 0 6px 0;
            font-size: 12px;
            font-weight: 600;
            color: #111827;
            padding: 6px 10px;
            background: #fafafa;
            border: 1px solid var(--line);
            border-radius: 8px;
        }

        /* Tables (NO fixed widths) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            table-layout: auto;
            /* critical: NOT fixed */
        }

        th,
        td {
            border: 1px solid var(--line);
            padding: 6px 7px;

            /* center values (per your request) */
            text-align: center;

            vertical-align: top;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            overflow-wrap: anywhere;
            word-break: break-word;
            font-weight: 400;
        }

        th {
            background: var(--panel);
            color: #111827;
            cursor: pointer;
            user-select: none;
            position: relative;
            font-weight: 500;
        }

        th.sortable:hover {
            filter: brightness(0.98);
        }

        th .sort-indicator {
            margin-left: 6px;
            font-size: 10px;
            color: var(--muted);
            font-weight: 400;
        }

        /* "Tight" cols: no padding; values stay on one line so width becomes "just what it needs" */
        th.tight,
        td.tight {
            padding: 0 !important;
        }

        td.tight {
            white-space: nowrap;
        }

        /* Header wrap by words (not breaking inside words) */
        th.tight {
            white-space: normal;
            overflow-wrap: normal;
            word-break: normal;
        }

        /* Work Description takes the remaining space (it wraps) */
        th.workdesc,
        td.workdesc {
            text-align: left;
            /* keep description readable */
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .subtotal td {
            background: #fbfbfb;
            font-weight: 400;
        }

        .grand-total {
            margin-top: 22px;
            text-align: right;
            font-size: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--line);
            font-weight: 400;
        }

        td.pastdue-yes {
            background: var(--chip-red-bg);
            color: var(--chip-red-tx);
            text-align: center;
            font-weight: 400;
        }

        td.pastdue-no {
            background: var(--chip-green-bg);
            color: var(--chip-green-tx);
            text-align: center;
            font-weight: 400;
        }

        td.heat {
            font-variant-numeric: tabular-nums;
            font-weight: 400;
            color: #111;
        }

        .pastdue-filters {
            display: flex;
            gap: 6px;
        }

        .pastdue-filters button {
            font-size: 10px;
            padding: 4px 8px;
            border: 1px solid var(--line);
            background: #fff;
            cursor: pointer;
            border-radius: 6px;
        }

        .pastdue-filters button.active {
            background: var(--panel);
        }

        @media print {
            .pastdue-filters {
                display: none !important;
            }

            body {
                margin: 10mm;
            }

            .vendor-section,
            table,
            tbody,
            tr,
            td,
            th {
                break-inside: auto !important;
                page-break-inside: auto !important;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }

            h2,
            h3,
            table {
                break-before: auto !important;
                page-break-before: auto !important;
            }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const normKey = (k) => String(k || "").trim().toLowerCase().replace(/\s+/g, "_");

            function findColIndex(table, wantedKeys) {
                const ths = Array.from(table.querySelectorAll("thead th"));
                for (let i = 0; i < ths.length; i++) {
                    const k = normKey(ths[i].dataset.key || ths[i].getAttribute("data-key") || ths[i].textContent);
                    if (wantedKeys.includes(k)) return i;
                }
                return -1;
            }

            function parseNumberFromCell(td) {
                const raw = (td?.getAttribute("data-sort") ?? td?.textContent ?? "").trim();
                if (!raw) return 0;
                const cleaned = raw.replace(/[\s,$]/g, "");
                const n = Number(cleaned);
                return Number.isFinite(n) ? n : 0;
            }

            function formatMoney(n) {
                return Number(n || 0).toLocaleString("en-CA", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function formatGenericNumber(num) {
                const hasDecimals = Math.abs(num % 1) > 0;
                return num.toLocaleString("en-CA", {
                    minimumFractionDigits: hasDecimals ? 2 : 0,
                    maximumFractionDigits: 2
                });
            }

            function rebuildSubtotalRow(table) {
                const ths = Array.from(table.querySelectorAll("thead th"));
                const colCount = ths.length;
                if (!colCount) return;

                const amtIdx = findColIndex(table, ["total_amount_with_taxes", "total_amount_with_tax", "total_amount"]);
                if (amtIdx < 0) return;

                const tfoot = table.querySelector("tfoot");
                const tr = tfoot?.querySelector("tr.subtotal");
                if (!tr) return;

                // sum visible rows only
                let subtotal = 0;
                table.querySelectorAll("tbody tr").forEach(row => {
                    if (row.style.display === "none") return;
                    subtotal += parseNumberFromCell(row.children[amtIdx]);
                });

                tr.innerHTML = "";

                const tdLabel = document.createElement("td");
                tdLabel.colSpan = Math.max(1, amtIdx);
                tdLabel.textContent = "Subtotal";
                tdLabel.style.textAlign = "right";
                tr.appendChild(tdLabel);

                const tdAmt = document.createElement("td");
                tdAmt.setAttribute("data-sort", String(subtotal));
                tdAmt.textContent = formatMoney(subtotal);
                tr.appendChild(tdAmt);

                const remaining = colCount - (tdLabel.colSpan + 1);
                for (let i = 0; i < remaining; i++) tr.appendChild(document.createElement("td"));
            }

            function applyColumnClasses(table) {
                const workIdx = findColIndex(table, ["work_description", "workdescription", "description", "work_desc"]);
                const ths = Array.from(table.querySelectorAll("thead th"));

                ths.forEach((th, idx) => {
                    th.classList.remove("tight", "workdesc");
                    if (idx === workIdx && workIdx !== -1) th.classList.add("workdesc");
                    else th.classList.add("tight");
                });

                table.querySelectorAll("tbody tr").forEach(tr => {
                    Array.from(tr.children).forEach((td, idx) => {
                        td.classList.remove("tight", "workdesc");
                        if (idx === workIdx && workIdx !== -1) td.classList.add("workdesc");
                        else td.classList.add("tight");
                    });
                });
            }

            // 1) Beautify column headers: snake_case -> Title Case (keep data-key unchanged)
            document.querySelectorAll("th.sortable").forEach(th => {
                const key = th.dataset.key || (th.childNodes[0]?.nodeValue || th.textContent || "").trim();
                const pretty = String(key)
                    .replace(/_/g, " ")
                    .toLowerCase()
                    .replace(/\b\w/g, c => c.toUpperCase());
                if (th.childNodes[0]) th.childNodes[0].nodeValue = pretty + " ";
                else th.textContent = pretty;
            });

            // Apply column classes (NO width fixing, only padding/wrap behavior)
            document.querySelectorAll("table.sortable-table").forEach(applyColumnClasses);

            // 2) Past Due filter buttons (works across all tables)
            const btns = Array.from(document.querySelectorAll(".pastdue-filters button"));
            const tables = Array.from(document.querySelectorAll("table.sortable-table"));

            function updateAllSubtotalsOnly() {
                tables.forEach(t => rebuildSubtotalRow(t));
            }

            if (btns.length) {
                function applyFilter(filter) {
                    tables.forEach(table => {
                        table.querySelectorAll("tbody tr").forEach(row => {
                            const cell = row.querySelector("td.pastdue-yes, td.pastdue-no");
                            if (!cell || filter === "all") {
                                row.style.display = "";
                                return;
                            }
                            const isPastDue = cell.classList.contains("pastdue-yes");
                            if (filter === "true") row.style.display = isPastDue ? "" : "none";
                            if (filter === "false") row.style.display = !isPastDue ? "" : "none";
                        });
                    });
                    updateAllSubtotalsOnly();
                }

                btns.forEach(btn => {
                    btn.addEventListener("click", () => {
                        btns.forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                        applyFilter(btn.dataset.filter);
                    });
                });

                applyFilter(
                    document.querySelector(".pastdue-filters button.active")?.dataset.filter || "all"
                );
            }

            // 3) Number formatting in tables:
            // - Past Due => Yes/No
            // - Invoice ID => NO thousands separators (only there)
            // - Everything else numeric => en-CA (with grouping)
            document.querySelectorAll("table.sortable-table").forEach(table => {
                const invoiceIdx = findColIndex(table, ["invoice_id", "invoiceid"]);
                const pastDueIdx = findColIndex(table, ["past_due", "pastdue"]);

                table.querySelectorAll("tbody tr").forEach(tr => {
                    const tds = Array.from(tr.children);

                    // Past due display
                    if (pastDueIdx >= 0 && tds[pastDueIdx]) {
                        const td = tds[pastDueIdx];
                        if (td.classList.contains("pastdue-yes")) td.textContent = "Yes";
                        if (td.classList.contains("pastdue-no")) td.textContent = "No";
                    }

                    tds.forEach((td, idx) => {
                        if (!td) return;

                        if (td.classList.contains("pastdue-yes") || td.classList.contains("pastdue-no")) return;

                        const raw = (td.getAttribute("data-sort") ?? td.textContent).trim();
                        if (!raw) return;

                        // Invoice ID: strip separators, do NOT locale-format
                        if (idx === invoiceIdx && invoiceIdx >= 0) {
                            td.textContent = raw.replace(/[\s,]/g, "");
                            return;
                        }

                        // Numeric formatting for everything else
                        const cleaned = raw.replace(/[\s,]/g, "");
                        if (!/^[-+]?\d*\.?\d+$/.test(cleaned)) return;

                        const num = Number(cleaned);
                        if (!Number.isFinite(num)) return;

                        td.textContent = formatGenericNumber(num);
                    });
                });
            });

            // 4) Vendor Total and Grand Total:
            // - keep thousands separators (restore grouping)
            // - format ALL numbers found in those elements
            function formatAllNumbersInElement(el) {
                const txt = el.textContent;
                const replaced = txt.replace(/([-+]?\d[\d,]*\.?\d*)/g, (m) => {
                    const n = Number(String(m).replace(/,/g, ""));
                    if (!Number.isFinite(n)) return m;
                    return n.toLocaleString("en-CA", {
                        minimumFractionDigits: n % 1 ? 2 : 0,
                        maximumFractionDigits: 2
                    });
                });
                el.textContent = replaced;
            }

            document.querySelectorAll(".vendor-pill, .grand-total").forEach(formatAllNumbersInElement);

            // Make sure subtotals are positioned under Total Amount With Taxes initially
            updateAllSubtotalsOnly();

            // Ensure print matches (recompute subtotals based on current filter before print)
            window.addEventListener("beforeprint", () => {
                updateAllSubtotalsOnly();
            });
        });
    </script>

</head>

<body>

    <div class="report-header">
        <div style="display:flex; align-items:center; gap:14px;">
            <h1>Unpaid Invoices</h1>

            <div class="pastdue-filters">
                <button data-filter="all" class="active">All</button>
                <button data-filter="true">Past Due</button>
                <button data-filter="false">Not Past Due</button>
            </div>
        </div>

        <img src="https://cnetbuildingmaintenanceservices.ca/wp-content/uploads/2022/04/Cnet_logo_apr2022_large.png"
            alt="CNET Building Maintenance Services" style="height:42px; object-fit:contain;" />
    </div>

    {# Grand totals split (STATIC; not filtered) #}
    {% set gns = namespace(total=0, current=0, past=0) %}

    {% for v in vendors %}
    {# Vendor totals split (STATIC; not filtered) #}
    {% set vns = namespace(total=0, current=0, past=0) %}

    {# Accumulate vendor totals from all rows #}
    {% for b in v.buyers %}
    {% for r in b.rows %}
    {% set pd = (r.get('past_due')|string|lower) in ['true','1','yes','y','past due','overdue'] %}
    {% set amt = (r.get('total_amount_with_taxes')|float if r.get('total_amount_with_taxes') is not none else 0) %}
    {% set vns.total = vns.total + amt %}
    {% if pd %}
    {% set vns.past = vns.past + amt %}
    {% else %}
    {% set vns.current = vns.current + amt %}
    {% endif %}
    {% endfor %}
    {% endfor %}

    {% set gns.total = gns.total + vns.total %}
    {% set gns.current = gns.current + vns.current %}
    {% set gns.past = gns.past + vns.past %}

    <section class="vendor-section">
        <div class="vendor-title">
            <h2>Vendor: {{ v.vendor }}</h2>

            <!-- Vendor totals WITH current/past (STATIC; no filtering) -->
            <div class="vendor-pill">
                Vendor total: {{ "%.2f"|format(vns.total) }}
                | Current: {{ "%.2f"|format(vns.current) }}
                | Past due: {{ "%.2f"|format(vns.past) }}
            </div>
        </div>

        {% for b in v.buyers %}
        <h3>Buyer: {{ b.buyer }}</h3>

        {# Compute maxima per buyer table (for heatmaps) #}
        {% set ns = namespace(max_days=0, max_amt=0) %}
        {% for r in b.rows %}
        {% if 'days_since_issue' in r and r['days_since_issue'] is not none %}
        {% set d = (r['days_since_issue']|float) %}
        {% if d > ns.max_days %}{% set ns.max_days = d %}{% endif %}
        {% endif %}
        {% if 'total_amount_with_taxes' in r and r['total_amount_with_taxes'] is not none %}
        {% set a = (r['total_amount_with_taxes']|float) %}
        {% if a > ns.max_amt %}{% set ns.max_amt = a %}{% endif %}
        {% endif %}
        {% endfor %}

        <table class="sortable-table">
            <thead>
                <tr>
                    {% for key in b.rows[0].keys() %}
                    <th class="sortable" data-key="{{ key }}">
                        {{ key }}<span class="sort-indicator"></span>
                    </th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for row in b.rows %}
                <tr>
                    {% for key, value in row.items() %}
                    {% set k = key|string|lower %}
                    {% set vstr = value|string|lower %}

                    {% if k in ['past_due', 'past due'] %}
                    {% set is_true = vstr in ['true','1','yes','y','past due','overdue'] %}
                    <td class="{{ 'pastdue-yes' if is_true else 'pastdue-no' }}" data-sort="{{ 1 if is_true else 0 }}">
                        {{ value }}
                    </td>

                    {% elif k in ['days_since_issue', 'days since issue'] %}
                    {% set past_due_val = row.get('past_due') %}
                    {% set is_past_due = (past_due_val|string|lower) in ['true','1','yes','y','past due','overdue'] %}

                    {% if is_past_due %}
                    {% set denom = (ns.max_days if ns.max_days > 0 else 1) %}
                    {% set raw_ratio = (value|float) / denom %}
                    {% if raw_ratio < 0 %}{% set raw_ratio=0 %}{% endif %} {% if raw_ratio> 1 %}{% set raw_ratio = 1
                        %}{% endif %}

                        {% set alpha = raw_ratio * (0.38) %}
                        {% if alpha < 0 %}{% set alpha=0 %}{% endif %} {% if alpha> 0.38 %}{% set alpha = 0.38 %}{%
                            endif %}

                            <td class="heat" data-sort="{{ value|float }}"
                                style="background-color: rgba(var(--heat-blue-r), var(--heat-blue-g), var(--heat-blue-b), {{ alpha }});">
                                {{ value }}
                            </td>
                            {% else %}
                            <td data-sort="{{ value|float }}">{{ value }}</td>
                            {% endif %}

                            {% elif k in ['total_amount_with_taxes', 'total amount with taxes'] %}
                            {% set denom = (ns.max_amt if ns.max_amt > 0 else 1) %}
                            {% set raw_ratio = (value|float) / denom %}
                            {% if raw_ratio < 0 %}{% set raw_ratio=0 %}{% endif %} {% if raw_ratio> 1 %}{% set raw_ratio
                                = 1 %}{% endif %}

                                {% set alpha = raw_ratio * (0.38) %}
                                {% if alpha < 0 %}{% set alpha=0 %}{% endif %} {% if alpha> 0.38 %}{% set alpha = 0.38
                                    %}{% endif %}

                                    <td class="heat" data-sort="{{ value|float }}"
                                        style="background-color: rgba(var(--heat-green-r), var(--heat-green-g), var(--heat-green-b), {{ alpha }});">
                                        {{ value }}
                                    </td>

                                    {% else %}
                                    {% if value is number %}
                                    <td data-sort="{{ value }}">{{ value }}</td>
                                    {% else %}
                                    <td data-sort="{{ value|string|lower }}">{{ value }}</td>
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>

            <tfoot>
                <!-- Will be rebuilt by JS so subtotal lands under Total Amount With Taxes and respects filter -->
                <tr class="subtotal">
                    <td colspan="{{ b.rows[0]|length - 1 }}">Subtotal</td>
                    <td data-sort="{{ b.subtotal }}">{{ "%.2f"|format(b.subtotal) }}</td>
                </tr>
            </tfoot>
        </table>
        {% endfor %}
    </section>
    {% endfor %}

    <!-- Grand totals WITH current/past (STATIC; no filtering) -->
    <div class="grand-total">
        Grand total: {{ "%.2f"|format(gns.total) }}
        | Current: {{ "%.2f"|format(gns.current) }}
        | Past due: {{ "%.2f"|format(gns.past) }}
    </div>

    <script>
        // Click-to-sort for each table (sorts only TBODY rows; keeps subtotal in TFOOT)
        (function () {
            function isNumericLike(val) {
                if (val === null || val === undefined) return false;
                const s = String(val).trim();
                if (s === "") return false;
                return !Number.isNaN(Number(s.replace(/[, $]/g, "")));
            }

            function getCellSortValue(td) {
                if (!td) return "";
                const ds = td.getAttribute("data-sort");
                if (ds !== null) return ds;

                const text = td.textContent.trim();
                return text.replace(/[, $]/g, "");
            }

            function compareValues(a, b, asc) {
                const aNum = isNumericLike(a) ? Number(String(a).replace(/[, $]/g, "")) : null;
                const bNum = isNumericLike(b) ? Number(String(b).replace(/[, $]/g, "")) : null;

                let cmp;
                if (aNum !== null && bNum !== null) {
                    cmp = aNum - bNum;
                } else {
                    cmp = String(a).localeCompare(String(b), undefined, { numeric: true, sensitivity: "base" });
                }
                return asc ? cmp : -cmp;
            }

            function clearIndicators(ths) {
                ths.forEach(th => {
                    th.dataset.sortDir = "";
                    const ind = th.querySelector(".sort-indicator");
                    if (ind) ind.textContent = "";
                });
            }

            document.querySelectorAll("table.sortable-table").forEach((table) => {
                const thead = table.querySelector("thead");
                const tbody = table.querySelector("tbody");
                if (!thead || !tbody) return;

                const headers = Array.from(thead.querySelectorAll("th.sortable"));
                headers.forEach((th, idx) => {
                    th.addEventListener("click", () => {
                        const current = th.dataset.sortDir === "asc" ? "asc" : th.dataset.sortDir === "desc" ? "desc" : "";
                        const nextDir = current === "asc" ? "desc" : "asc";

                        clearIndicators(headers);
                        th.dataset.sortDir = nextDir;

                        const indicator = th.querySelector(".sort-indicator");
                        if (indicator) indicator.textContent = nextDir === "asc" ? "▲" : "▼";

                        const rows = Array.from(tbody.querySelectorAll("tr"));
                        rows.sort((r1, r2) => {
                            const c1 = r1.children[idx];
                            const c2 = r2.children[idx];
                            const v1 = getCellSortValue(c1);
                            const v2 = getCellSortValue(c2);
                            return compareValues(v1, v2, nextDir === "asc");
                        });

                        rows.forEach(r => tbody.appendChild(r));

                        // Subtotals depend on filter; sort doesn't change visibility,
                        // but recompute anyway for safety (function lives in head script).
                        if (typeof window !== "undefined" && window.dispatchEvent) {
                            // trigger beforeprint-like recompute by calling print handler indirectly is messy;
                            // the head script already recomputes on filter and beforeprint, and initial load.
                        }
                    });
                });
            });
        })();
    </script>

</body>

</html>